<!DOCTYPE HTML>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Urknall Documentation - QuickStart</title>
<link rel="stylesheet" href="../../stylesheet.css">
<link href="../../css/pygments.css" media="screen" rel="stylesheet" type="text/css">

<!-- Bootstrap -->
<link href="../../css/bootstrap.min.css" rel="stylesheet">

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
		<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
		<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
	<![endif]-->

<!-- you don't need to keep this, but it's cool for stats! -->
<meta name="generator" content="nanoc 3.7.2">
</head>



<body>
<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" href="../../">Urknall Documentation</a>
		</div>
		<div class="collapse navbar-collapse">
			<ul class="nav navbar-nav">
				<li class="active"><a href="./">QuickStart</a></li>
				<li><a href="../library/">Library</a></li>
				<li><a href="../binary/">Binary</a></li>
			</ul>
		</div><!--/.nav-collapse -->
	</div>
</div>




<div class="container">

<h1 class="no_toc" id="getting-started">Getting Started</h1>

<p>This guide will demonstrate how to create a provisioning tool to deploy this
documentation’s pages behind a nginx, thereby showing the nuts and bolts of
urknall.</p>

<ul id="markdown-toc">
  <li><a href="#requirements">Requirements</a></li>
  <li><a href="#creating-the-basic-project">Creating The Basic Project</a></li>
  <li><a href="#running-the-basic-example">Running The Basic Example</a></li>
  <li>
<a href="#extending-the-basic-project">Extending The Basic Project</a>    <ul>
      <li><a href="#the-templating-system">The Templating System</a></li>
      <li><a href="#using-the-installed-templates">Using The Installed Templates</a></li>
    </ul>
  </li>
  <li><a href="#conclusion">Conclusion</a></li>
</ul>

<h2 id="requirements">Requirements</h2>

<p>Make sure urknall is properly installed as described <a href="../installation/">here</a>.
Additionally a machine is needed to provision to (see
<a href="https://www.virtualbox.org">VirtualBox</a> on how to create a virtual machine),
that should meet the following requirements:</p>

<ul>
  <li>The machine should have Ubuntu Trust 14.04 installed.</li>
  <li>The machine must be accessible via SSH.</li>
  <li>If the user on the machine is not <code>root</code>, he must be allowed to run commands
using <code>sudo</code>, <a href="../library/#sudo_without_password">without being asked for a password</a>.</li>
</ul>

<h2 id="creating-the-basic-project">Creating The Basic Project</h2>

<p>First the basic project is created in the <code>example</code> subdirectory, using the
urknall <a href="../binary/">binary</a>’s <code>init</code> command:</p>

<pre><code class="language-shell highlight"><span class="gp">$ </span>urknall init example</code></pre>

<p>Besides the a basic set of <a href="../binary/#project-scaffolding">commands</a>, the
<code>main.go</code> file is creatted, that ahs code that configures and drives the
urknall <a href="../library">library</a> with a simple <a href="../library/#templates">template</a>.
The generated code can be compiled to a binary, used to do the actual
provisioning.</p>

<h2 id="running-the-basic-example">Running The Basic Example</h2>

<p>After changing the <code>uri</code> and <code>password</code> variables’ values in the <code>main.go</code> file
the example code can be compiled and run.</p>

<pre><code class="language-bash highlight"><span class="gp">$ </span>go get . <span class="o">&amp;&amp;</span> example
<span class="o">[</span>ubuntu@192.168.56.10:22][hello       <span class="o">][</span>  0.600][EXEC    <span class="o">][</span>COMMAND] <span class="c"># echo hello world</span>
<span class="o">[</span>ubuntu@192.168.56.10:22][hello       <span class="o">][</span>  0.610] + <span class="nb">echo </span>hello world
<span class="o">[</span>ubuntu@192.168.56.10:22][hello       <span class="o">][</span>  0.610] hello world
<span class="o">[</span>ubuntu@192.168.56.10:22][hello       <span class="o">][</span>  0.621][FINISHED][COMMAND] <span class="c"># echo hello world</span></code></pre>

<p>The output shows a log of all commands run and their respective outputs (as
seen when using bash’s <code>-x</code> flag). If the example is run a second time the
output changes:</p>

<pre><code class="language-bash highlight"><span class="gp">$ </span>go get . <span class="o">&amp;&amp;</span> example
<span class="o">[</span>ubuntu@192.168.56.10:22][hello       <span class="o">][</span>  0.257][CACHED  <span class="o">][</span>COMMAND] <span class="c"># echo hello world</span></code></pre>

<p>This shows the caching mechanism in effect (notice the <em>CACHED</em> mark in the
fourth field). As the command was already executed and nothing changed, nothing
had to be done. The next section will show the possibilities of extending the
basic template.</p>

<h2 id="extending-the-basic-project">Extending The Basic Project</h2>

<p>The basic template instanciated when calling urknall is now extended to
demonstrate the execution of proper commands. The task at hand is to serve
urknall’s documentation using nginx. Ruby is required to generate the pages
using the <a href="http://nanoc.ws">nanoc</a> static page generator.</p>

<h3 id="the-templating-system">The Templating System</h3>

<p>First the templates for <em>ruby</em> and <em>nginx</em> provided with urknall are installed.
The urknall binary is able to <a href="../binary/#template_management">list</a> and
<a href="../binary/#template_management">add</a> provided templates:</p>

<pre><code class="language-bash highlight"><span class="gp">$ </span>urknall templates list
available packages:
<span class="o">[</span>..]
<span class="k">*</span> nginx
<span class="k">*</span> ruby
<span class="o">[</span>..]
<span class="gp">$ </span>urknall templates add nginx ruby
loading content from <span class="s2">"https://api.github.com/repos/dynport/urknall/contents/examples/tpl_nginx.go?ref=master"</span>
loading content from <span class="s2">"https://api.github.com/repos/dynport/urknall/contents/examples/tpl_ruby.go?ref=master"</span></code></pre>

<p>Now there are two files <code>tpl_nginx.go</code> and <code>tpl_ruby.go</code> that can be used as
rough sketch for this project’s requirements. Actually no modifications to
these templates are required for this project, so next they can be included
with the provisioning mechanism.</p>

<h3 id="using-the-installed-templates">Using The Installed Templates</h3>

<p>The templates installed in the previous subsections must be integrated into the
template hierarchy to be used. The root of this hierarchy is the template
rendered to the target with the call to urknall’s <code>Run</code> method. This value’s
type is now modified, to add the <em>ruby</em> and <em>nginx</em> templates required. For
the sake of demonstration the <a href="../library/#annotations">annotation mechanism</a>
is used to specify a default version for nginx and require an explicit version
for ruby.</p>

<pre><code class="language-golang highlight"><span class="k">type</span><span class="x"> </span><span class="n">Template</span><span class="x"> </span><span class="k">struct</span><span class="x"> </span><span class="p">{</span><span class="x">
  </span><span class="n">RubyVersion</span><span class="x">  </span><span class="kt">string</span><span class="x"> </span><span class="s">`urknall:"required=true"`</span><span class="x">
  </span><span class="n">NginxVersion</span><span class="x"> </span><span class="kt">string</span><span class="x"> </span><span class="s">`urknall:"default=1.4.1"`</span><span class="x">
</span><span class="p">}</span></code></pre>

<p>Next the template’s <code>Render</code> method is modified. First a command is added to
make sure that the system’s package cache is updated and the installed packages
are upgraded. This prevents errors related to an outdated package cache. Next
the two templates that were added in the peviosn chapter are added.</p>

<pre><code class="language-golang highlight"><span class="k">func</span><span class="x"> </span><span class="p">(</span><span class="n">tpl</span><span class="x"> </span><span class="o">*</span><span class="n">Template</span><span class="p">)</span><span class="x"> </span><span class="n">Render</span><span class="p">(</span><span class="n">p</span><span class="x"> </span><span class="n">urknall</span><span class="o">.</span><span class="n">Package</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
  </span><span class="n">p</span><span class="o">.</span><span class="n">AddCommands</span><span class="p">(</span><span class="s">"pkg-update"</span><span class="p">,</span><span class="x"> </span><span class="n">UpdatePackages</span><span class="p">())</span><span class="x">

  </span><span class="n">ruby</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="o">&amp;</span><span class="n">Ruby</span><span class="p">{</span><span class="n">Version</span><span class="o">:</span><span class="x"> </span><span class="n">tpl</span><span class="o">.</span><span class="n">RubyVersion</span><span class="p">}</span><span class="x">
  </span><span class="n">p</span><span class="o">.</span><span class="n">AddTemplate</span><span class="p">(</span><span class="s">"ruby"</span><span class="p">,</span><span class="x"> </span><span class="n">ruby</span><span class="p">)</span><span class="x">

  </span><span class="n">nginx</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="o">&amp;</span><span class="n">Nginx</span><span class="p">{</span><span class="n">Version</span><span class="o">:</span><span class="x"> </span><span class="n">tpl</span><span class="o">.</span><span class="n">NginxVersion</span><span class="p">}</span><span class="x">
  </span><span class="n">p</span><span class="o">.</span><span class="n">AddTemplate</span><span class="p">(</span><span class="s">"nginx"</span><span class="p">,</span><span class="x"> </span><span class="n">nginx</span><span class="p">)</span><span class="x">
</span><span class="p">}</span></code></pre>

<p>In a second step the root template is configured to specify the required ruby
version.</p>

<pre><code class="language-golang highlight"><span class="k">func</span><span class="x"> </span><span class="n">run</span><span class="p">()</span><span class="x"> </span><span class="kt">error</span><span class="x"> </span><span class="p">{</span><span class="x">
  </span><span class="p">[</span><span class="o">...</span><span class="p">]</span><span class="x">
  </span><span class="k">return</span><span class="x"> </span><span class="n">urknall</span><span class="o">.</span><span class="n">Run</span><span class="p">(</span><span class="n">target</span><span class="p">,</span><span class="x"> </span><span class="o">&amp;</span><span class="n">Template</span><span class="p">{</span><span class="n">RubyVersion</span><span class="o">:</span><span class="x"> </span><span class="s">"2.1.2"</span><span class="p">})</span><span class="x">
</span><span class="p">}</span></code></pre>

<p>The final tasks retrieve the documentation’s code, compile it and configure
nginx to serve the output.</p>

<pre><code class="language-golang highlight"><span class="k">func</span><span class="x"> </span><span class="p">(</span><span class="n">tpl</span><span class="x"> </span><span class="o">*</span><span class="n">Template</span><span class="p">)</span><span class="x"> </span><span class="n">Render</span><span class="p">(</span><span class="n">p</span><span class="x"> </span><span class="n">urknall</span><span class="o">.</span><span class="n">Package</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
  </span><span class="p">[</span><span class="o">...</span><span class="p">]</span><span class="x">
  </span><span class="c">// Clone the documentation and compile it using nanoc.</span><span class="x">
  </span><span class="n">p</span><span class="o">.</span><span class="n">AddCommands</span><span class="p">(</span><span class="s">"github.docs"</span><span class="p">,</span><span class="x">
	</span><span class="n">InstallPackages</span><span class="p">(</span><span class="s">"git"</span><span class="p">),</span><span class="x">
	</span><span class="n">Shell</span><span class="p">(</span><span class="n">ruby</span><span class="o">.</span><span class="n">InstallDir</span><span class="p">()</span><span class="o">+</span><span class="s">"/bin/gem install bundle"</span><span class="p">),</span><span class="x">
	</span><span class="n">AsUser</span><span class="p">(</span><span class="s">"ubuntu"</span><span class="p">,</span><span class="x"> </span><span class="s">"git clone https://github.com/nanoc/nanoc.ws.git docs"</span><span class="p">),</span><span class="x">
	</span><span class="n">AsUser</span><span class="p">(</span><span class="s">"ubuntu"</span><span class="p">,</span><span class="x"> </span><span class="s">"export PATH=${PATH}:"</span><span class="o">+</span><span class="n">ruby</span><span class="o">.</span><span class="n">InstallDir</span><span class="p">()</span><span class="o">+</span><span class="s">"/bin &amp;&amp;cd docs &amp;&amp; bundle install &amp;&amp; nanoc compile"</span><span class="p">),</span><span class="x">
  </span><span class="p">)</span><span class="x">

  </span><span class="c">// Configure nginx to use nanoc's output as root.</span><span class="x">
  </span><span class="n">p</span><span class="o">.</span><span class="n">AddCommands</span><span class="p">(</span><span class="s">"nginx.conf"</span><span class="p">,</span><span class="x">
	</span><span class="n">Shell</span><span class="p">(</span><span class="s">`sed -e "s.root \+html;.root /home/ubuntu/docs/output;." -i `</span><span class="o">+</span><span class="n">nginx</span><span class="o">.</span><span class="n">ConfDir</span><span class="p">()</span><span class="o">+</span><span class="s">`/nginx.conf`</span><span class="p">),</span><span class="x">
	</span><span class="n">Shell</span><span class="p">(</span><span class="s">"service nginx start"</span><span class="p">),</span><span class="x">
  </span><span class="p">)</span><span class="x">
</span><span class="p">}</span></code></pre>

<p>Now everything is setup, configured and started, i.e. the documentation is
reachable using the machine’s public IP.</p>

<h2 id="conclusion">Conclusion</h2>

<p>This guide showed how to create a basic provisioning tool for the simple task
of deploying some static pages generated with a static page generator. The
final code should look like the following, with the commands and templates
being unaltered.</p>

<pre><code class="language-golang highlight"><span class="k">package</span><span class="x"> </span><span class="n">main</span><span class="x">

</span><span class="k">import</span><span class="x"> </span><span class="p">(</span><span class="x">
  </span><span class="s">"log"</span><span class="x">
  </span><span class="s">"os"</span><span class="x">

  </span><span class="s">"github.com/dynport/urknall"</span><span class="x">
</span><span class="p">)</span><span class="x">

</span><span class="k">var</span><span class="x"> </span><span class="n">logger</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">log</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">Stderr</span><span class="p">,</span><span class="x"> </span><span class="s">""</span><span class="p">,</span><span class="x"> </span><span class="m">0</span><span class="p">)</span><span class="x">

</span><span class="k">func</span><span class="x"> </span><span class="n">main</span><span class="p">()</span><span class="x"> </span><span class="p">{</span><span class="x">
  </span><span class="k">if</span><span class="x"> </span><span class="n">e</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">run</span><span class="p">();</span><span class="x"> </span><span class="n">e</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="n">logger</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="x">
  </span><span class="p">}</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="k">type</span><span class="x"> </span><span class="n">Template</span><span class="x"> </span><span class="k">struct</span><span class="x"> </span><span class="p">{</span><span class="x">
  </span><span class="n">RubyVersion</span><span class="x">  </span><span class="kt">string</span><span class="x"> </span><span class="s">`urknall:"required=true"`</span><span class="x">
  </span><span class="n">NginxVersion</span><span class="x"> </span><span class="kt">string</span><span class="x"> </span><span class="s">`urknall:"default=1.4.1"`</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="k">func</span><span class="x"> </span><span class="p">(</span><span class="n">tpl</span><span class="x"> </span><span class="o">*</span><span class="n">Template</span><span class="p">)</span><span class="x"> </span><span class="n">Render</span><span class="p">(</span><span class="n">p</span><span class="x"> </span><span class="n">urknall</span><span class="o">.</span><span class="n">Package</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
  </span><span class="n">p</span><span class="o">.</span><span class="n">AddCommands</span><span class="p">(</span><span class="s">"pkg-update"</span><span class="p">,</span><span class="x"> </span><span class="n">UpdatePackages</span><span class="p">())</span><span class="x">

  </span><span class="n">ruby</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="o">&amp;</span><span class="n">Ruby</span><span class="p">{</span><span class="n">Version</span><span class="o">:</span><span class="x"> </span><span class="n">tpl</span><span class="o">.</span><span class="n">RubyVersion</span><span class="p">}</span><span class="x">
  </span><span class="n">p</span><span class="o">.</span><span class="n">AddTemplate</span><span class="p">(</span><span class="s">"ruby"</span><span class="p">,</span><span class="x"> </span><span class="n">ruby</span><span class="p">)</span><span class="x">

  </span><span class="n">nginx</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="o">&amp;</span><span class="n">Nginx</span><span class="p">{</span><span class="n">Version</span><span class="o">:</span><span class="x"> </span><span class="n">tpl</span><span class="o">.</span><span class="n">NginxVersion</span><span class="p">}</span><span class="x">
  </span><span class="n">p</span><span class="o">.</span><span class="n">AddTemplate</span><span class="p">(</span><span class="s">"nginx"</span><span class="p">,</span><span class="x"> </span><span class="n">nginx</span><span class="p">)</span><span class="x">

  </span><span class="c">// Clone the documentation and compile it using nanoc.</span><span class="x">
  </span><span class="n">p</span><span class="o">.</span><span class="n">AddCommands</span><span class="p">(</span><span class="s">"github.docs"</span><span class="p">,</span><span class="x">
	</span><span class="n">InstallPackages</span><span class="p">(</span><span class="s">"git"</span><span class="p">),</span><span class="x">
	</span><span class="n">Shell</span><span class="p">(</span><span class="n">ruby</span><span class="o">.</span><span class="n">InstallDir</span><span class="p">()</span><span class="o">+</span><span class="s">"/bin/gem install bundle"</span><span class="p">),</span><span class="x">
	</span><span class="n">AsUser</span><span class="p">(</span><span class="s">"ubuntu"</span><span class="p">,</span><span class="x"> </span><span class="s">"git clone https://github.com/nanoc/nanoc.ws.git docs"</span><span class="p">),</span><span class="x">
	</span><span class="n">AsUser</span><span class="p">(</span><span class="s">"ubuntu"</span><span class="p">,</span><span class="x"> </span><span class="s">"export PATH=${PATH}:"</span><span class="o">+</span><span class="n">ruby</span><span class="o">.</span><span class="n">InstallDir</span><span class="p">()</span><span class="o">+</span><span class="s">"/bin &amp;&amp; cd docs &amp;&amp; bundle install &amp;&amp; nanoc compile"</span><span class="p">),</span><span class="x">
  </span><span class="p">)</span><span class="x">

  </span><span class="c">// Configure nginx to use nanoc's output as root.</span><span class="x">
  </span><span class="n">p</span><span class="o">.</span><span class="n">AddCommands</span><span class="p">(</span><span class="s">"nginx.conf"</span><span class="p">,</span><span class="x">
	</span><span class="n">Shell</span><span class="p">(</span><span class="s">`sed -e "s.root \+html;.root /home/ubuntu/docs/output;." -i `</span><span class="o">+</span><span class="n">nginx</span><span class="o">.</span><span class="n">ConfDir</span><span class="p">()</span><span class="o">+</span><span class="s">`/nginx.conf`</span><span class="p">),</span><span class="x">
	</span><span class="n">Shell</span><span class="p">(</span><span class="s">"service nginx start"</span><span class="p">),</span><span class="x">
  </span><span class="p">)</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="k">func</span><span class="x"> </span><span class="n">run</span><span class="p">()</span><span class="x"> </span><span class="kt">error</span><span class="x"> </span><span class="p">{</span><span class="x">
  </span><span class="k">defer</span><span class="x"> </span><span class="n">urknall</span><span class="o">.</span><span class="n">OpenLogger</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">Stdout</span><span class="p">)</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span><span class="x">
  </span><span class="k">var</span><span class="x"> </span><span class="n">target</span><span class="x"> </span><span class="n">urknall</span><span class="o">.</span><span class="n">Target</span><span class="x">
  </span><span class="k">var</span><span class="x"> </span><span class="n">e</span><span class="x"> </span><span class="kt">error</span><span class="x">
  </span><span class="n">uri</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="s">"ubuntu@192.168.56.10"</span><span class="x">
  </span><span class="n">password</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="s">"ubuntu"</span><span class="x">
  </span><span class="k">if</span><span class="x"> </span><span class="n">password</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="s">""</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">target</span><span class="p">,</span><span class="x"> </span><span class="n">e</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">urknall</span><span class="o">.</span><span class="n">NewSshTargetWithPassword</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span><span class="x"> </span><span class="n">password</span><span class="p">)</span><span class="x">
  </span><span class="p">}</span><span class="x"> </span><span class="k">else</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">target</span><span class="p">,</span><span class="x"> </span><span class="n">e</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">urknall</span><span class="o">.</span><span class="n">NewSshTarget</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span><span class="x">
  </span><span class="p">}</span><span class="x">
  </span><span class="k">if</span><span class="x"> </span><span class="n">e</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="k">return</span><span class="x"> </span><span class="n">e</span><span class="x">
  </span><span class="p">}</span><span class="x">
  </span><span class="k">return</span><span class="x"> </span><span class="n">urknall</span><span class="o">.</span><span class="n">Run</span><span class="p">(</span><span class="n">target</span><span class="p">,</span><span class="x"> </span><span class="o">&amp;</span><span class="n">Template</span><span class="p">{</span><span class="n">RubyVersion</span><span class="o">:</span><span class="x"> </span><span class="s">"2.1.2"</span><span class="p">})</span><span class="x">
</span><span class="p">}</span></code></pre>


</div>


<hr/>

<footer>
<div class="container">
	<p>© <a href="http://www.dynport.de">Dynport GmbH</a> 2014</p>
</div>
</footer>


<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="../../js/bootstrap.min.js"></script>
</body>
</html>
